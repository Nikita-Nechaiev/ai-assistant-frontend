name: Frontend CI

on:
  push:
    branches: [main, feature__github_actions]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
      mailhog:
        image: mailhog/mailhog
        ports:
          - 1025:1025
          - 8025:8025

    env:
      CI: true
      NEXT_TELEMETRY_DISABLED: 1

    steps:
      # ---------- FRONTEND ----------
      - name: Checkout frontend
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            package-lock.json
            backend/package-lock.json

      # ---------- BACKEND ----------
      - name: Checkout backend
        uses: actions/checkout@v4
        with:
          repository: Nikita-Nechaiev/ai-assistant-backend
          token: ${{ secrets.BACKEND_PAT }}
          path: backend

      - name: Install backend deps
        working-directory: backend
        run: npm ci

      - name: Build backend
        working-directory: backend
        run: npm run build

      - name: DB migrate (skip if none)
        working-directory: backend
        run: echo "No migration script – skipping"

      - name: Start backend (port 3002)
        id: start_backend
        working-directory: backend
        env:
          NODE_ENV: development
          PORT: 3002

          # DB
          POSTGRES_HOST: localhost
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
          POSTGRES_PORT: '5432'

          # Dummy Google OAuth to avoid crash
          GOOGLE_CLIENT_ID: 'ci-dummy-client-id'
          GOOGLE_CLIENT_SECRET: 'ci-dummy-secret'
          GOOGLE_CALLBACK_URL: 'http://localhost:3002/auth/google/callback'

          # Safe test values
          JWT_ACCESS_SECRET: test-access
          JWT_REFRESH_SECRET: test-refresh
          SMTP_HOST: localhost
          SMTP_PORT: '1025'
          SMTP_USER: test@example.com
          SMTP_PASSWORD: test
          SMTP_FROM: '"Your App" <no-reply@yourapp.com>'
          FRONTEND_URL: http://localhost:3000
          OPENAI_API_KEY: test
        run: |
          nohup npm run start:prod > ../backend.log 2>&1 &
          npx --yes wait-on --timeout 120000 http://localhost:3002/health || \
          npx --yes wait-on --timeout 120000 tcp:3002
          echo "Backend is up"

      - name: Print backend log on failure
        if: failure() || cancelled()
        run: |
          echo "==== backend.log (tail) ===="
          tail -n 200 backend.log || true

      # ---------- USERS FOR E2E ----------
      - name: Ensure inviter & invitee users exist
        env:
          INVITER_EMAIL: ${{ secrets.E2E_INVITER_EMAIL || 'test1@example.com' }}
          INVITER_PASSWORD: ${{ secrets.E2E_INVITER_PASSWORD || 'Password1!' }}
          INVITEE_EMAIL: ${{ secrets.E2E_INVITEE_EMAIL || 'test@example.com' }}
          INVITEE_PASSWORD: ${{ secrets.E2E_INVITEE_PASSWORD || 'Password1!' }}
        run: |
          set -e
          ensure_user () {
            local email="$1"; local password="$2"; local name="$3"
            local code
            code=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Content-Type: application/json" \
              -d "{\"email\":\"$email\",\"password\":\"$password\"}" \
              http://localhost:3002/auth/login || true)
            if [ "$code" != "200" ] && [ "$code" != "201" ]; then
              curl -s -o /dev/null \
                -H "Content-Type: application/json" \
                -d "{\"email\":\"$email\",\"password\":\"$password\",\"name\":\"$name\"}" \
                http://localhost:3002/auth/register || true
            fi
          }
          ensure_user "$INVITER_EMAIL" "$INVITER_PASSWORD" "E2E Inviter"
          ensure_user "$INVITEE_EMAIL" "$INVITEE_PASSWORD" "E2E Invitee"

      # ---------- FRONTEND ----------
      - name: Install frontend deps (with dev)
        run: npm ci --include=dev

      # ESLint только по фронтовым папкам (без backend/**)
      - name: Lint
        run: |
          npx eslint \
            "components/**/*.{ts,tsx,js,jsx}" \
            "ui/**/*.{ts,tsx,js,jsx}" \
            "hooks/**/*.{ts,tsx,js,jsx}" \
            "store/**/*.{ts,tsx,js,jsx}" \
            "services/**/*.{ts,tsx,js,jsx}" \
            --no-error-on-unmatched-pattern \
            --max-warnings 0

      - name: Unit tests (Jest) with coverage
        run: npm run test:cov -- --testPathIgnorePatterns="[\\\\/]backend[\\\\/]" --coveragePathIgnorePatterns="[\\\\/]backend[\\\\/]"

      - name: Upload Jest coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jest-coverage
          path: coverage/

      # Next читает .env.local
      - name: Create .env.local for Next dev (API/Socket → localhost:3002)
        run: |
          cat > .env.local <<EOF
          NEXT_PUBLIC_API_URL=http://localhost:3002
          NEXT_PUBLIC_SOCKET_URL=http://localhost:3002
          NODE_ENV=development
          EOF

      # Переменные для Playwright/фикстур
      - name: Create .env.test.local for Playwright
        env:
          INVITER_EMAIL: ${{ secrets.E2E_INVITER_EMAIL || 'test1@example.com' }}
          INVITER_PASSWORD: ${{ secrets.E2E_INVITER_PASSWORD || 'Password1!' }}
          INVITEE_EMAIL: ${{ secrets.E2E_INVITEE_EMAIL || 'test@example.com' }}
          INVITEE_PASSWORD: ${{ secrets.E2E_INVITEE_PASSWORD || 'Password1!' }}
        run: |
          cat > .env.test.local <<EOF
          # Логин по умолчанию (фикстура login может использовать это)
          E2E_EMAIL=$INVITER_EMAIL
          E2E_PASSWORD=$INVITER_PASSWORD
          E2E_REFRESH=yourTestRefreshToken

          # Для сценариев инвайтов
          E2E_INVITER_EMAIL=$INVITER_EMAIL
          E2E_INVITER_PASSWORD=$INVITER_PASSWORD
          E2E_INVITEE_EMAIL=$INVITEE_EMAIL
          E2E_INVITEE_PASSWORD=$INVITEE_PASSWORD

          NEXT_PUBLIC_API_URL=http://localhost:3002
          NEXT_PUBLIC_SOCKET_URL=http://localhost:3002
          EOF

      - name: Start Next.js (dev) on :3000
        env:
          PORT: 3000
          NEXT_PUBLIC_API_URL: http://localhost:3002
          NEXT_PUBLIC_SOCKET_URL: http://localhost:3002
        run: |
          nohup npm run dev > web.log 2>&1 &
          npx --yes wait-on --timeout 120000 http://localhost:3000

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright e2e
        env:
          PW_BASE_URL: http://localhost:3000
        run: npm run test:e2e

      # ---------- Артефакты ----------
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/

      - name: Upload backend log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-log
          path: backend.log

      - name: Upload frontend log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-log
          path: web.log
